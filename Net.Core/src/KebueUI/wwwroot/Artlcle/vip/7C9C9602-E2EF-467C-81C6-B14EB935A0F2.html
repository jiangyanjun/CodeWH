<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="Language" content="zh-CN">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../images/kebue.ico">
    <link rel="icon" href="../../images/kebue.ico">
    <meta name="description" content=SQL Server DBA>
    <meta name="keywords" content=SQL Server DBA11. 查询数据库各种历史记录在SQL Server数据库中，从登陆开始，然后做了什么操作，以及数据库里发生了什么，大多都是有记录可循的，但是也有一些确实无从查起。一.数据库启动记录1.最近一次启动SQL Server的时间selectsqlserver_start_timefromsys.dm_os_sys_info;--也可参考系统进程创建的时间，比服务启动时间略晚>
    <title>SQL Server DBA</title>

    <link href="../../template/scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../template/styles/custom.css" rel="stylesheet" />
</head>
<body id="pageBody">
    <div id="divBoxed" class="container">
        <div class="transparent-bg" style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: -1;zoom: 1;"></div>
        <div class="divPanel notop nobottom">
            <div class="row-fluid">
                <div class="span12">
                    <div id="divLogo">
                        <a href="../../../Home/Index" id="divSiteTitle">科布尔 kebue</a><br />
                        <a href="../../../Home/Index" id="divTagLine">开发者用代码改变世界从科布尔开始</a>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div id="divMenuRight" class="pull-right">
                        <div class="navbar">
                            <button type="button" class="btn btn-navbar-highlight btn-large btn-primary" data-toggle="collapse" data-target=".nav-collapse">
                                NAVIGATION <span class="icon-chevron-down icon-white"></span>
                            </button>
                            <div class="nav-collapse collapse">
                                <ul class="nav nav-pills ddmenu">
                                    <li class="dropdown glyphicon glyphicon-arrow-left"><a href='javascript:window.history.back()'>后退</a></li>
                                    <li class="dropdown active"><a href="http://www.kebue.com/">Home</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div id="contentInnerSeparator"></div>
                </div>
            </div>
        </div>
        <div class="contentArea">
            <div class="divPanel notop page-content">
                <div class="breadcrumbs">
                    <a href="../../../Home/Index">Home</a> &nbsp;/&nbsp; <span><a href='../../../../../Artlcle/ArticleType/A6B67D7C-1B75-4AF4-AF00-7D4EF126AFA9.html' title='SQLServer'>SQLServer</a></span>
                </div>
                <div class="row-fluid">
                    <div class="span12" id="divMain">
                        <h1>SQL Server DBA</h1>
                        <pre>
                        <code>
                            <p><a href="http://www.cnblogs.com/seusoftware/" style="background-color: inherit; cursor: pointer;">SQL Server DBA</a></p><p><br/></p><h1 style="background-color: inherit;"><a href="http://www.cnblogs.com/seusoftware/p/4826958.html" style="background-color: inherit; cursor: pointer;">11. 查询数据库各种历史记录</a></h1><p style="background-color: inherit;">在SQL Server数据库中，从登陆开始，然后做了什么操作，以及数据库里发生了什么，大多都是有记录可循的，但是也有一些确实无从查起。</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">一</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">数据库启动记录</strong></span></p><p style="background-color: inherit;"><strong style="background-color: inherit;">1.&nbsp;</strong><strong style="background-color: inherit;">最近一次启动</strong><strong style="background-color: inherit;">SQL Server</strong><strong style="background-color: inherit;">的时间</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">select&nbsp;sqlserver_start_time&nbsp;from&nbsp;sys.dm_os_sys_info;--也可参考系统进程创建的时间，比服务启动时间略晚(秒级)select&nbsp;login_time&nbsp;from&nbsp;sysprocesses&nbsp;where&nbsp;spid&nbsp;=1select&nbsp;login_time&nbsp;from&nbsp;sys.dm_exec_sessions&nbsp;where&nbsp;session_id&nbsp;=1--也可参考tempdb数据库创建的时间，比服务启动时间略晚(秒级)select&nbsp;create_date&nbsp;from&nbsp;sys.databases&nbsp;  where&nbsp;database_id=2</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2.&nbsp;</strong><strong style="background-color: inherit;">最近几次启动</strong><strong style="background-color: inherit;">SQL Server</strong><strong style="background-color: inherit;">的时间</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--参考error&nbsp;log，系统默认保留6个归档，共7个文件exec&nbsp;xp_readerrorlog&nbsp;0,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;1,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;2,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;3,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;4,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;5,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;exec&nbsp;xp_readerrorlog&nbsp;6,1,&nbsp;N&#39;Server&nbsp;process&nbsp;ID&nbsp;is&#39;</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">3.&nbsp;</strong><strong style="background-color: inherit;">历史上更多次启动</strong><strong style="background-color: inherit;">SQL Server</strong><strong style="background-color: inherit;">的时间</strong></p><p style="background-color: inherit;">查看windows event log，SQL语句无法直接读取event log，如果想用命令行，可以试试VBS，Powershell。</p><p style="background-color: inherit;">Event Viewer/Windows logs下Application 或者 System 事件里都有服务启动的记录。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;">二.&nbsp;<strong style="background-color: inherit;">登陆数据库记录</strong></span></p><p style="background-color: inherit;"><strong style="background-color: inherit;">1.&nbsp;</strong><strong style="background-color: inherit;">查看</strong><strong style="background-color: inherit;">error log</strong></p><p style="background-color: inherit;">默认情况下，只有失败的登录会被记录在error log里，如果想登录失败/成功都被记录到error log，需要开启如图选项：</p><p style="background-color: inherit;">&nbsp;<img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" data-media-type="image" data-attr-org-src-id="6344AE5EA1BE4EB0A0E620E62D486C31" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/d415256c1a1146b3be1e73d16233e72a/37-988829192.png" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/d415256c1a1146b3be1e73d16233e72a/37-988829192.png"/></p><p style="background-color: inherit;">用SQL语句修改注册表，也同样可以开启，键值对应关系如下：</p><p style="background-color: inherit;">0, None</p><p style="background-color: inherit;">1, Failed</p><p style="background-color: inherit;">2, Successful</p><p style="background-color: inherit;">3, Both failed and successful</p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">USE[master]GOEXEC&nbsp;xp_instance_regwrite&nbsp;N&#39;HKEY_LOCAL_MACHINE&#39;,&nbsp;N&#39;Software\Microsoft\MSSQLServer\MSSQLServer&#39;,&nbsp;N&#39;AuditLevel&#39;,&nbsp;REG_DWORD,&nbsp;3GO</pre><p style="background-color: inherit;">在error log里查看登录记录：</p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">exec&nbsp;xp_readerrorlog&nbsp;0,1,&nbsp;N&#39;Login&#39;,&nbsp;N&#39;for&nbsp;user&#39;,&nbsp;null,&nbsp;null,&nbsp;N&#39;DESC&#39;</pre><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2.&nbsp;</strong><strong style="background-color: inherit;">利用</strong><strong style="background-color: inherit;">LOGON&nbsp;</strong><strong style="background-color: inherit;">触发器进行记录</strong></p><p style="background-color: inherit;">从SQL Server 2005 SP2开始引入了LOGON Trigger，可以用它在登录时做个记录，实现如下：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--创建LOGON触发器CREATEdatabase&nbsp;DBAGOUSE&nbsp;DBAGOIFOBJECT_ID(&#39;login_history&#39;,&#39;U&#39;)&nbsp;isnotnullDROPTABLE&nbsp;login_historyGOCREATETABLE&nbsp;login_history  (  FACT_ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigintIDENTITY(1,1)&nbsp;primarykey,  LOGIN_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nvarchar(1024),  LOGIN_TIME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datetime)GOIFEXISTS(select1from&nbsp;sys.server_triggers&nbsp;where&nbsp;name&nbsp;=&#39;login_history_trigger&#39;)&nbsp;&nbsp;&nbsp;&nbsp;DROPTRIGGER&nbsp;login_history_trigger&nbsp;ONALL&nbsp;SERVERGOCREATETRIGGER&nbsp;login_history_triggerONALL&nbsp;SERVERFOR&nbsp;LOGONASBEGIN--IF&nbsp;SUSER_NAME()&nbsp;NOT&nbsp;LIKE&nbsp;&#39;NT&nbsp;AUTHORITY\%&#39;&nbsp;AND&nbsp;--&nbsp;&nbsp;&nbsp;SUSER_NAME()&nbsp;NOT&nbsp;LIKE&nbsp;&#39;NT&nbsp;SERVICE\%&#39;IF&nbsp;ORIGINAL_LOGIN()&nbsp;NOTLIKE&#39;NT&nbsp;AUTHORITY\%&#39;AND  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORIGINAL_LOGIN()&nbsp;NOTLIKE&#39;NT&nbsp;SERVICE\%&#39;BEGININSERTINTO&nbsp;DBA..login_history&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES(ORIGINAL_LOGIN(),GETDATE());&nbsp;&nbsp;&nbsp;&nbsp;END;END;GO--登录后查看记录SELECT*FROM&nbsp;login_history</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">三</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">创建，修改，删除记录</strong><strong style="background-color: inherit;">&nbsp;(DDL)</strong></span></p><p style="background-color: inherit;"><strong style="background-color: inherit;">1.&nbsp;</strong><strong style="background-color: inherit;">服务器对象的创建，修改</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--创建数据库select&nbsp;name,&nbsp;create_date&nbsp;from&nbsp;sys.databases--创建，修改登录select&nbsp;name,&nbsp;createdate,&nbsp;updatedate&nbsp;from&nbsp;sysloginsselect&nbsp;name,&nbsp;create_date,&nbsp;modify_date&nbsp;from&nbsp;sys.server_principals&nbsp;    --创建，修改LOGON触发器select&nbsp;name,&nbsp;create_date,&nbsp;modify_date&nbsp;from&nbsp;sys.server_triggers</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2.&nbsp;</strong><strong style="background-color: inherit;">数据库对象创建，修改</strong></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--创建数据库对象select&nbsp;name,&nbsp;create_date,&nbsp;modify_date&nbsp;from&nbsp;sys.objects&nbsp;    --创建，修改触发器，DDL触发器不在sys.objects里select&nbsp;name,&nbsp;create_date,&nbsp;modify_date&nbsp;from&nbsp;sys.triggers</pre><p style="background-color: inherit;">注意：</p><p style="background-color: inherit;"><strong style="background-color: inherit;">(1)&nbsp;</strong><strong style="background-color: inherit;">索引的创建，修改并没有记录</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">sys.objects&nbsp;--里面没有0,1&nbsp;之外的索引sys.indexes&nbsp;--里面没有日期objectproperty()&nbsp;--没有日期属性indexproperty()&nbsp;&nbsp;--没有日期属性sys.dm_db_index_operational_stats&nbsp;  sys.dm_db_index_usage_stats  sys.dm_db_index_physical_stats&nbsp;--也都没有STATS_DATE&nbsp;(table_id,&nbsp;index_id)&nbsp;--是索引的统计信息最后更新时间</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;"><strong style="background-color: inherit;">(2)&nbsp;</strong><strong style="background-color: inherit;">关于creator</strong><strong style="background-color: inherit;">和owner</strong></p><p style="background-color: inherit;">SQL Server里只有owner，数据库里对象的owner必须是一个有效的database principal (user或者role)，没有creator，很难知道是谁创建了这个对象，因为owner并不准确：</p><p style="background-color: inherit;">首先，数据库对象的owner可以被修改，ALTER AUTHORIZATION或者sp_changeobjectowner都行；</p><p style="background-color: inherit;">其次，就算owner没被修改过，默认情况下数据库对象的owner沿用schema的owner，除非在创建schema时特意指定了某个owner；</p><p style="background-color: inherit;">最后，系统表并没有记录creator，如果想要查询，也许得利用DDL 触发器来记录。</p><p style="background-color: inherit;">关于owner简单举例如下：&nbsp;</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" data-media-type="image" data-attr-org-src-id="AC19ED867DFC4F24832B5794D012DF63" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/ea9f47b9df0046e7aa0f2470bacf3af3/tractedblock.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/ea9f47b9df0046e7aa0f2470bacf3af3/tractedblock.gif"/><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" data-media-type="image" data-attr-org-src-id="A59BFC04D17040D9AFDE2F08E1317566" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/64354e63905242fe96ee014bdffe3073/edblockstart.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/64354e63905242fe96ee014bdffe3073/edblockstart.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--用sysadmin权限的账号登录后创建USE&nbsp;masterGOCREATE&nbsp;LOGIN&nbsp;test_login&nbsp;WITH&nbsp;PASSWORD=N&#39;123&#39;,&nbsp;DEFAULT_DATABASE=master,&nbsp;CHECK_EXPIRATION=OFF,&nbsp;CHECK_POLICY=OFFALTER&nbsp;SERVER&nbsp;ROLE&nbsp;sysadmin&nbsp;ADD&nbsp;MEMBER&nbsp;test_loginGOCREATEdatabase&nbsp;DBAGOUSE&nbsp;DBAGOCREATEUSER&nbsp;test_user&nbsp;FOR&nbsp;LOGIN&nbsp;test_loginGOCREATESCHEMA&nbsp;test_schemaGO--用&quot;test_login&quot;登录后建表ifOBJECT_ID(&#39;test_schema.test_owner&#39;,&#39;U&#39;)&nbsp;isnotnulldroptable&nbsp;test_schema.test_ownerGOcreatetable&nbsp;test_schema.test_owner(id&nbsp;int)GO--表的owner还是用了schema的ownerselect&nbsp;s.name&nbsp;as&nbsp;schema_name,&nbsp;dp2.name&nbsp;as&nbsp;schema_owner,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.name&nbsp;asobject_name,&nbsp;coalesce(dp1.name,&nbsp;dp2.name)&nbsp;as&nbsp;object_owner,*from&nbsp;sys.objects&nbsp;oinnerjoin&nbsp;sys.schemas&nbsp;son&nbsp;o.schema_id&nbsp;=&nbsp;s.schema_idleftjoin&nbsp;sys.database_principals&nbsp;dp1on&nbsp;o.principal_id&nbsp;=&nbsp;dp1.principal_idleftjoin&nbsp;sys.database_principals&nbsp;dp2on&nbsp;s.principal_id&nbsp;=&nbsp;dp2.principal_idwhere&nbsp;o.name&nbsp;=&#39;test_owner&#39;--用objectproperty也可以查看ownerselect&nbsp;name&nbsp;as&nbsp;object_ownerfrom&nbsp;sys.database_principals&nbsp;  where&nbsp;principal_id&nbsp;=OBJECTPROPERTY(object_id(&#39;test_schema.test_owner&#39;),&#39;OwnerId&#39;)</pre><p>object owner</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">3.&nbsp;</strong><strong style="background-color: inherit;">默认跟踪里的创建，修改，删除对象</strong><strong style="background-color: inherit;">&nbsp;(create, alter, drop)</strong></p><p style="background-color: inherit;">从sql server 2005开始引入了默认跟踪，这是sql server默认开启的跟踪，并定义了事件、文件大小，个数，查看定义如下：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">&nbsp;t.eventid,&nbsp;te.name&nbsp;(&nbsp;eventid&nbsp;&nbsp;sys.fn_trace_geteventinfo())&nbsp;t&nbsp;sys.trace_events&nbsp;te&nbsp;t.eventid&nbsp;&nbsp;te.trace_event_id&nbsp;sys.traces&nbsp;id</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">示例，利用默认跟踪查看删除数据库记录如下：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">DECLARE@pathvarchar(1024)SELECT@path=&nbsp;pathFROM&nbsp;sys.traceswhere&nbsp;id&nbsp;=1SELECT*FROM&nbsp;fn_trace_gettable(@path,&nbsp;1)where&nbsp;DatabaseName&nbsp;=&#39;DBA&#39;and&nbsp;EventClass&nbsp;=47--46表示Create对象，47表示Drop对象，164表示修改对象and&nbsp;ObjectType&nbsp;=16964--16964表示数据库</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;">注意：</p><p style="background-color: inherit;">(1) 其他对象比如表的删除等也都可以查到；</p><p style="background-color: inherit;">(2) 跟踪返回的列值有很多定义，没有系统表记载，需要去翻帮助，比如ObjectType列值参考这个列表：</p><p style="background-color: inherit;"><a href="https://msdn.microsoft.com/en-us/library/ms180953.aspx" style="background-color: inherit; cursor: pointer;">https://msdn.microsoft.com/en-us/library/ms180953.aspx</a></p><p style="background-color: inherit;">(3) 注意默认跟踪的时效性，5个20MB的文件，也许想要看的信息很快就被覆盖了；</p><p style="background-color: inherit;">(4) &nbsp;truncate table并没有被默认跟踪记录。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">四</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">数据库表的各种记录</strong></span></p><p style="background-color: inherit;">汇总一下对表的各种历史操作记录的查看：</p><p style="background-color: inherit;">(1) create table, alter table记录，查看sys.objects 或者默认跟踪；</p><p style="background-color: inherit;">(2) drop table记录，查看默认跟踪；</p><p style="background-color: inherit;">(3) truncate table 也许只有去打开数据库log文件查看了，最后会简单介绍下；</p><p style="background-color: inherit;">(4) DML操作表中数据的记录，查?磗ys.dm_db_index_usage_stats，如下：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">SELECT&nbsp;o.name&nbsp;as&nbsp;table_name,&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.last_user_seek,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.last_user_scan,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.last_user_lookup,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.last_user_updatefrom&nbsp;sys.indexes&nbsp;i&nbsp;  leftjoin&nbsp;sys.dm_db_index_usage_stats&nbsp;s&nbsp;  on&nbsp;s.object_id=&nbsp;i.object_idand&nbsp;  &nbsp;&nbsp;&nbsp;s.index_id&nbsp;=&nbsp;i.index_id&nbsp;  innerjoin&nbsp;sys.objects&nbsp;oon&nbsp;i.object_id=&nbsp;o.object_idwhere&nbsp;i.index_id&nbsp;&lt;=1and&nbsp;o.is_ms_shipped&nbsp;=0orderby&nbsp;o.name</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">注意：动态管理视图(DMV) 中采集来的信息都是从sql server启动后开始的，也就是说重启后就没了。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">五</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">历史</strong><strong style="background-color: inherit;">SQL</strong><strong style="background-color: inherit;">语句记录</strong></span></p><p style="background-color: inherit;">有些数据库本身，会记录所有历史的SQL命令。比如：mysql和pgsql都有专门的log文本文件来存放所有历史的SQL命令；</p><p style="background-color: inherit;">也有些数据库在保存log文本的同时，还保留最近的N条SQL命令在数据库里，以方便查询。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;">SQL Server并没有这样的实现，只有sys.dm_exec_query_stats缓存了一部分 (sql server服务开启后执行的语句，某些不被缓存执行计划的语句并不记录)。</p><p style="background-color: inherit;">这个视图主要是对执行计划的统计，包含消耗成本，运行次数等等，并没有session，user，每次被执行的时间等信息：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">SELECT&nbsp;st.textas&nbsp;sql_statement,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qs.creation_time&nbsp;as&nbsp;plan_last_compiled,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qs.last_execution_time&nbsp;as&nbsp;plan_last_executed,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qs.execution_count&nbsp;as&nbsp;plan_executed_count,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qp.query_planFROM&nbsp;sys.dm_exec_query_stats&nbsp;qsCROSS&nbsp;APPLY&nbsp;sys.dm_exec_sql_text(qs.plan_handle)&nbsp;stCROSS&nbsp;APPLY&nbsp;sys.dm_exec_query_plan(qs.plan_handle)&nbsp;qporderby&nbsp;total_elapsed_time/execution_count&nbsp;desc</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">当然，开启跟踪，审计之类的方法，是可以记录所有操作的，但是这个开销有可能会影响系统性能，所以一般并不在生产环境启用。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">六</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">数据库备份还原历史记录</strong></span></p><p style="background-color: inherit;">备份还原的记录都在msdb里。</p><p style="background-color: inherit;"><strong style="background-color: inherit;">1.&nbsp;</strong><strong style="background-color: inherit;">备份记录</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">SELECT&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.backup_set_id,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.database_name,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.backup_start_date,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.backup_finish_date,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CAST(CAST(bs.backup_size/1000000ASINT)&nbsp;ASVARCHAR(14))&nbsp;+&#39;&#39;+&#39;MB&#39;AS[Size],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CAST(DATEDIFF(second,&nbsp;bs.backup_start_date,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.backup_finish_date)&nbsp;ASVARCHAR(4))&nbsp;+&#39;&#39;+&#39;Seconds&#39;[TimeTaken],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CASE&nbsp;bs.[type]WHEN&#39;D&#39;THEN&#39;Full&nbsp;Backup&#39;WHEN&#39;I&#39;THEN&#39;Differential&nbsp;Backup&#39;WHEN&#39;L&#39;THEN&#39;TLog&nbsp;Backup&#39;WHEN&#39;F&#39;THEN&#39;File&nbsp;or&nbsp;filegroup&#39;WHEN&#39;G&#39;THEN&#39;Differential&nbsp;file&#39;WHEN&#39;P&#39;THEN&#39;Partial&#39;WHEN&#39;Q&#39;THEN&#39;Differential&nbsp;Partial&#39;ENDAS&nbsp;BackupType,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bmf.physical_device_name,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CAST(bs.first_lsn&nbsp;ASVARCHAR(50))&nbsp;AS&nbsp;first_lsn,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CAST(bs.last_lsn&nbsp;ASVARCHAR(50))&nbsp;AS&nbsp;last_lsn,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.server_name,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.recovery_model&nbsp;FROM&nbsp;msdb.dbo.backupset&nbsp;bs&nbsp;INNERJOIN&nbsp;msdb.dbo.backupmediafamily&nbsp;bmf&nbsp;  &nbsp;ON&nbsp;bs.media_set_id&nbsp;=&nbsp;bmf.media_set_id&nbsp;ORDERBY&nbsp;bs.server_name,bs.database_name,bs.backup_start_date;GO</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">如果server_name是本机，那么备份是在本机生成的；</p><p style="background-color: inherit;">如果server_name是别的主机名，那么备份是被拿到本机做过数据库还原；</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2.&nbsp;</strong><strong style="background-color: inherit;">还原纪录</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">SELECT&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[restore_history_id],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[restore_date],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[destination_database_name],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bmf.physical_device_name,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[user_name],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[backup_set_id],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CASE&nbsp;rs.[restore_type]WHEN&#39;D&#39;THEN&#39;Database&#39;WHEN&#39;I&#39;THEN&#39;Differential&#39;WHEN&#39;L&#39;THEN&#39;Log&#39;WHEN&#39;F&#39;THEN&#39;File&#39;WHEN&#39;G&#39;THEN&#39;Filegroup&#39;WHEN&#39;V&#39;THEN&#39;Verifyonly&#39;ENDAS&nbsp;RestoreType,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[replace],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[recovery],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[restart],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[stop_at],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[device_count],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[stop_at_mark_name],  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs.[stop_before]FROM[msdb].[dbo].[restorehistory]&nbsp;rs&nbsp;INNERJOIN[msdb].[dbo].[backupset]&nbsp;bs&nbsp;on&nbsp;rs.backup_set_id&nbsp;=&nbsp;bs.media_set_id&nbsp;INNERJOIN&nbsp;msdb.dbo.backupmediafamily&nbsp;bmf&nbsp;  &nbsp;ON&nbsp;bs.media_set_id&nbsp;=&nbsp;bmf.media_set_idGO</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">还原数据库的时候是会写backupset和backupmediafamily系统表的，用来记录还原所用到的备份文件信息。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">七</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">作业，维护计划，数据库邮件历史记录</strong></span></p><p style="background-color: inherit;">作业，维护计划，数据库邮件的历史记录，也都在msdb里。</p><p style="background-color: inherit;"><strong style="background-color: inherit;">1.&nbsp;</strong><strong style="background-color: inherit;">作业历史记录</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">ifOBJECT_ID(&#39;tempdb..#tmp_job&#39;)&nbsp;isnotnulldroptable&nbsp;#tmp_job--只取最后一次结果select&nbsp;job_id,  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_status,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(varchar(20),run_date)&nbsp;run_date,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(varchar(20),run_time)&nbsp;run_time,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(varchar(20),run_duration)&nbsp;run_duration&nbsp;&nbsp;into&nbsp;#tmp_job&nbsp;&nbsp;from&nbsp;msdb.dbo.sysjobhistory&nbsp;jh1&nbsp;where&nbsp;jh1.step_id&nbsp;=0and&nbsp;(selectCOUNT(1)&nbsp;from&nbsp;msdb.dbo.sysjobhistory&nbsp;jh2&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;jh2.step_id&nbsp;=0and&nbsp;(jh1.job_id&nbsp;=&nbsp;jh2.job_id)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(jh1.instance_id&nbsp;&lt;=&nbsp;jh2.instance_id))=1--排除syspolicy_purge_history这个系统作业select&nbsp;a.name&nbsp;job_name,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;b.run_status&nbsp;when0then&#39;Failed&#39;when1then&#39;Succeeded&#39;when2then&#39;Retry&#39;when3then&#39;Canceled&#39;else&#39;Unknown&#39;endas&nbsp;job_status,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEFT(run_date,4)+&#39;-&#39;+SUBSTRING(run_date,5,2)+&#39;-&#39;+RIGHT(run_date,2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+SPACE(1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+LEFT(RIGHT(1000000+run_time,6),2)+&#39;:&#39;+SUBSTRING(RIGHT(1000000+run_time,6),3,2)+&#39;:&#39;+RIGHT(RIGHT(1000000+run_time,6),2)&nbsp;as&nbsp;job_started_time,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+LEFT(RIGHT(1000000+run_duration,6),2)+&#39;:&#39;+SUBSTRING(RIGHT(1000000+run_duration,6),3,2)+&#39;:&#39;+RIGHT(RIGHT(1000000+run_duration,6),2)&nbsp;as&nbsp;job_duration&nbsp;&nbsp;from&nbsp;msdb.dbo.sysjobs&nbsp;a&nbsp;  &nbsp;&nbsp;leftjoin&nbsp;&nbsp;&nbsp;&nbsp;#tmp_job&nbsp;b&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;a.job_id=b.job_id&nbsp;  &nbsp;where&nbsp;a.name&nbsp;notin&nbsp;(&#39;syspolicy_purge_history&#39;)&nbsp;&nbsp;&nbsp;and&nbsp;a.enabled&nbsp;=1orderby&nbsp;b.run_status&nbsp;asc,a.name,b.run_duration&nbsp;desc</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2.&nbsp;</strong><strong style="background-color: inherit;">维护计划历史记录</strong></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">select*from&nbsp;msdb..sysdbmaintplan_history--新的系统表也可以select*from&nbsp;msdb..sysmaintplan_logselect*from&nbsp;msdb..sysmaintplan_logdetail</pre><p style="background-color: inherit;">维护计划最终是作为作业在运行的，也可以直接查看同名作业的历史记录。</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">3.&nbsp;</strong><strong style="background-color: inherit;">数据库邮件历史记录</strong></p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">--直接查系统表select*from&nbsp;msdb..sysmail_mailitemsselect*from&nbsp;msdb..sysmail_log--也可查看基于这2个系统表的系统视图select*from&nbsp;msdb..sysmail_allitemsselect*from&nbsp;msdb..sysmail_sentitemsselect*from&nbsp;msdb..sysmail_unsentitemsselect*from&nbsp;msdb..sysmail_faileditemsselect*from&nbsp;msdb..sysmail_event_log--更多系统表和视图use&nbsp;msdbGOselect*from&nbsp;sys.objects&nbsp;  where&nbsp;name&nbsp;like&#39;%sysmail%&#39;and&nbsp;type&nbsp;in(&#39;U&#39;,&#39;V&#39;)orderby&nbsp;type,name</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><span style="background-color: inherit; font-size: 18px;"><strong style="background-color: inherit;">八</strong><strong style="background-color: inherit;">.&nbsp;</strong><strong style="background-color: inherit;">查看数据库日志文件</strong></span></p><p style="background-color: inherit;">数据库日志文件里对于DDL，DML操作肯定是有记录的，有2个内置函数可以用来解析，但是并不那么轻松，简单介绍如下：</p><p style="background-color: inherit;"><strong style="background-color: inherit;">1. fn_dblog&nbsp;</strong><strong style="background-color: inherit;">读取当前在线的日志</strong></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">select*from&nbsp;fn_dblog(null,null)&nbsp;--2个null代表起始的日志LSN</pre><p style="background-color: inherit;">返回的结果集中字段定义：</p><p style="background-color: inherit;">(1) AllocUnitName: 对象名</p><p style="background-color: inherit;">(2) Operation: 操作类型，常见的有 &#39;LOP_INSERT_ROWS&#39;, &#39;LOP_DELETE_ROWS&#39;, &#39;LOP_MODIFY_ROW&#39;</p><p style="background-color: inherit;">(3) [RowLog Contents 0], [RowLog Contents 1], 2,3,4,5: 字段内容，但是是二进制的，和dbcc page看到的类似</p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;">试着查看truncate table记录如下：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><pre style="font-family: Monaco, Consolas, Courier, &#39;Lucida Console&#39;, monospace; background-color: inherit;">IFOBJECT_ID(&#39;test_truncate&#39;,&#39;U&#39;)&nbsp;isnotnullDROPTABLE&nbsp;test_truncateGOCREATETABLE&nbsp;test_truncate(ID&nbsp;int)INSERTINTO&nbsp;test_truncate&nbsp;values(1)TRUNCATETABLE&nbsp;test_truncate--查看truncate&nbsp;table记录select*from&nbsp;fn_dblog(null,null)where&nbsp;AllocUnitName&nbsp;like&#39;%test_truncate%&#39;and&nbsp;Description&nbsp;like&#39;Deallocated%&#39;</pre><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" data-attr-org-src-id="6A9DDBB41AFD4ACA94F3AF89BF859146" data-attr-org-img-file="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif" style="background:url(http://wafxw.cn/ueditor/lang/zh-cn/images/localimage.png) no-repeat center center;border:1px solid #ddd" word_img="file:///C:/Users/Tony.Jiang/AppData/Local/YNote/data/aaaaq@126.com/6ed97017089d41f694a259dbf0a67f41/copycode.gif"/></p><p style="background-color: inherit;">&nbsp;</p><p style="background-color: inherit;"><strong style="background-color: inherit;">2. fn_dump_dblog&nbsp;</strong><strong style="background-color: inherit;">读取数据库备份里的日志</strong></p><p style="background-color: inherit;">参数介绍：前面两2个NULL和fn_dblog一样代表起始的日志LSN，DISK表示设备类型，1表示备份文件个数，最多64个，这里以1个文件为例：</p><p><img src="http://wafxw.cn/ueditor/themes/default/images/spacer.gif" alt="复制代码" data-media-type="image" dat
                        </code>
                        </pre>
                        <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
                        <!-- UY BEGIN -->
                        <div id="uyan_frame"></div>
                        <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2113268"></script>
                        <!-- UY END -->
                    </div>
                </div>
                <div id="footerInnerSeparator"></div>
            </div>
        </div>
        <div id="footerOuterSeparator"></div>
    </div>
    <br /><br /><br />
    <script src="../../js/jquery-1.9.1.js"></script>
    <script>
        window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": $("#divMain pre code").text(), "bdMini": "2", "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {}, "image": { "viewList": ["qzone", "tsina", "tqq", "renren", "weixin"], "viewText": "分享到：", "viewSize": "16" }, "selectShare": { "bdContainerClass": null, "bdSelectMiniList": ["qzone", "tsina", "tqq", "renren", "weixin"] } }; with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</body>
</html>