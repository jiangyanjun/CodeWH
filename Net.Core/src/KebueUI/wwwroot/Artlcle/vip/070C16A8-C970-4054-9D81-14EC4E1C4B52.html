<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="Language" content="zh-CN">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../images/kebue.ico">
    <link rel="icon" href="../../images/kebue.ico">
    <meta name="description" content=.Net缓存管理框架CacheManager>
    <meta name="keywords" content=Cache缓存在计算机领域是一个被普遍使用的概念。硬件中CPU有一级缓存，二级缓存， 浏览器中有缓存，软件开发中也有分布式缓存memcache, redis。缓存无处不在的原因是它能够极大地提高硬件和软件的运行速度。在项目开发中，性能慢的地方常常是IO操作频繁的地方，读取数据库是我们常见的消耗性能的地方。这个时候，如果将使用频繁的数据缓存到能够高速读取的介质中，下次访问时，不用再去请求数据库，直接>
    <title>.Net缓存管理框架CacheManager</title>

    <link href="../../template/scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../template/styles/custom.css" rel="stylesheet" />
</head>
<body id="pageBody">
    <div id="divBoxed" class="container">
        <div class="transparent-bg" style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: -1;zoom: 1;"></div>
        <div class="divPanel notop nobottom">
            <div class="row-fluid">
                <div class="span12">
                    <div id="divLogo">
                        <a href="../../../Home/Index" id="divSiteTitle">科布尔 kebue</a><br />
                        <a href="../../../Home/Index" id="divTagLine">开发者用代码改变世界从科布尔开始</a>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div id="divMenuRight" class="pull-right">
                        <div class="navbar">
                            <button type="button" class="btn btn-navbar-highlight btn-large btn-primary" data-toggle="collapse" data-target=".nav-collapse">
                                NAVIGATION <span class="icon-chevron-down icon-white"></span>
                            </button>
                            <div class="nav-collapse collapse">
                                <ul class="nav nav-pills ddmenu">
                                    <li class="dropdown glyphicon glyphicon-arrow-left"><a href='javascript:window.history.back()'>后退</a></li>
                                    <li class="dropdown active"><a href="http://www.kebue.com/">Home</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div id="contentInnerSeparator"></div>
                </div>
            </div>
        </div>
        <div class="contentArea">
            <div class="divPanel notop page-content">
                <div class="breadcrumbs">
                    <a href="../../../Home/Index">Home</a> &nbsp;/&nbsp; <span><a href='../../../../../Artlcle/ArticleType/B8C0509A-82D4-4BD7-A1BB-5BAF70ED1C60.html' title='.NET'>.NET</a></span>
                </div>
                <div class="row-fluid">
                    <div class="span12" id="divMain">
                        <h1>.Net缓存管理框架CacheManager</h1>
                        <pre>
                        <code>
                            <p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.8; color: rgb(255, 102, 0);">Cache</span>缓存在计算机领域是一个被普遍使用的概念。硬件中CPU有一级缓存，二级缓存， 浏览器中有缓存，软件开发中也有分布式缓存memcache, redis。缓存无处不在的原因是它能够极大地提高硬件和软件的运行速度。在项目开发中，性能慢的地方常常是IO操作频繁的地方，读取数据库是我们常见的消耗性能的地方。这个时候，如果将使用频繁的数据缓存到能够高速读取的介质中，下次访问时，不用再去请求数据库，直接从缓存中获取所需的数据，就能够大大提高性能。这篇文章主要讨论的是在.Net开发中，如何使用CacheManager框架方便的管理项目中的缓存。</p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">一，CacheManager介绍以及优点</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.8; color: rgb(255, 102, 0);">CacheManager是开源的.Net缓存管理框架。它不是具体的缓存实现，而是在缓存之上，方便开发人员配置和管理各种不同的缓存，为上层应用程序提供统一的缓存接口的中间层。</span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">下面是CacheManager的一些优点:</p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>让开发人员的生活更容易处理和配资缓存，即使是非常复杂的缓存方案。</p></li><li><p>CacheManager能够管理多种缓存，包含 内存, appfabric, redis, couchbase， windows azure cache, memorycache等。</p></li><li><p>提供了额外的功能，如缓存同步、并发更新、事件、性能计数器等…</p></li></ul><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">二，<strong>CacheManager开始之旅</strong></h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">CacheManager上手还是非常简单的。下面使用内存缓存结合CacheManager的一个实例，能够帮助我们快速的熟悉CacheManager如何使用。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">首先在Visual Studio中创建一个Console Application.</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><img alt="" src="http://images2015.cnblogs.com/blog/14408/201511/14408-20151130104641671-1505926800.jpg" style="border: 0px;"/></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">使用<span style="line-height: 1.8; color: rgb(255, 102, 0);">Nuget</span>为项目添加CacheManager包引用。CacheManager包含了很多的Package. 其中CacheManager.Core是必须的，其它的针对不同缓存平台上有不同的对应Package.</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">这个Demo中，我们使用内存作为缓存，所以只是需要CacheManager.Core和CacheManager.SystemRuntimeCaching</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><img alt="" src="http://images2015.cnblogs.com/blog/14408/201511/14408-20151130104659374-844252951.jpg" style="border: 0px;"/></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">接着在Main函数中配置好我们的缓存:</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">&nbsp;1&nbsp;using&nbsp;System;&nbsp;2&nbsp;using&nbsp;CacheManager.Core;&nbsp;3&nbsp;namespace&nbsp;ConsoleApplication&nbsp;4&nbsp;{&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Program&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;void&nbsp;Main(string[]&nbsp;args)&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;cache&nbsp;=&nbsp;CacheFactory.Build(&quot;getStartedCache&quot;,&nbsp;settings&nbsp;=&gt;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings.WithSystemRuntimeCacheHandle(&quot;handleName&quot;);12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}15&nbsp;}</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.5;">上面代码中使用CacheFactory创建了一个名称为getStartedCache的缓存实例，这个缓存实例使用的是SystemRunTime Cache, 内存缓存。一个缓存实例是可以配置多个Handle的，我们可以使用内存来作为存储介质，也可以使用Redis分布式缓存作为存储介质，并且可以同时在一个缓存实例中使用，后面我们再介绍多级缓存的配置和使用。</span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">接下来，我们添加一些测试缓存的代码</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">&nbsp;1&nbsp;static&nbsp;void&nbsp;Main(string[]&nbsp;args)&nbsp;2&nbsp;{&nbsp;3&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;cache&nbsp;=&nbsp;CacheFactory.Build(&quot;getStartedCache&quot;,&nbsp;settings&nbsp;=&gt;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings.WithSystemRuntimeCacheHandle(&quot;handleName&quot;);&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});&nbsp;8&nbsp;&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.Add(&quot;keyA&quot;,&nbsp;&quot;valueA&quot;);10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.Put(&quot;keyB&quot;,&nbsp;23);11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.Update(&quot;keyB&quot;,&nbsp;v&nbsp;=&gt;&nbsp;42);12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;KeyA&nbsp;is&nbsp;&quot;&nbsp;+&nbsp;cache.Get(&quot;keyA&quot;));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;should&nbsp;be&nbsp;valueA13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;KeyB&nbsp;is&nbsp;&quot;&nbsp;+&nbsp;cache.Get(&quot;keyB&quot;));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;should&nbsp;be&nbsp;4214&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.Remove(&quot;keyA&quot;);15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;KeyA&nbsp;removed?&nbsp;&quot;&nbsp;+&nbsp;(cache.Get(&quot;keyA&quot;)&nbsp;==&nbsp;null).ToString());16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;We&nbsp;are&nbsp;done...&quot;);17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.ReadKey();18&nbsp;}</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">三，CacheManager多级缓存配置</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">实际开发中，我们常常会需要使用多级缓存。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">一种常见的情况是，你有一个分布式式缓存服务器，例如redis，独立的缓存服务器能够让我们的多个系统应用程序都能够共享这些缓存的数据，因为这些缓存项的创建是昂贵的。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">和访问数据库相比，分布式缓存速度较快，但是和内存相比，还是不够快。因为分布式缓存使用还需要序列化和网络传输的时间消耗。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">这个时候里，做个分级缓存是个好的解决方案，将内存缓存结合分布式缓存使用，使用频率高的数据直接从内存中读取，这将大大提高应用程序的整体?阅堋?/p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">使用内存缓存的读取速度能够达到分布式缓存的100倍，甚至更高。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">使用CacheManager, 配置多级缓存是一件非常容易的事情</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">&nbsp;1&nbsp;var&nbsp;cache&nbsp;=&nbsp;CacheFactory.Build&lt;int&gt;(&quot;myCache&quot;,&nbsp;settings&nbsp;=&gt;&nbsp;2&nbsp;{&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithSystemRuntimeCacheHandle(&quot;inProcessCache&quot;)//内存缓存Handle&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.And&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisConfiguration(&quot;redis&quot;,&nbsp;config&nbsp;=&gt;//Redis缓存配置&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.WithAllowAdmin()&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithDatabase(0)10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithEndpoint(&quot;localhost&quot;,&nbsp;6379);11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithMaxRetries(1000)//尝试次数13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRetryTimeout(100)//尝试超时时间14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisBackPlate(&quot;redis&quot;)//redis使用Back&nbsp;Plate15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisCacheHandle(&quot;redis&quot;,&nbsp;true);//redis缓存handle16&nbsp;});</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.5;">上面代码中，内存缓存和Redis缓存配置部分很容易看明白。但是BackPlate是什么作用? 接下来，我们看看CacheManager中的BackPlate挡板机制。</span></p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">四， BackPlate解决分布式缓存中的同步问题</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">对于大型的软件系统，常常都是分为很多独立的子项目，各个子项目为了节约成本或者是方便数据共享，常常会共用同一个分布缓存服务器。这样在使用多级缓存的时候，就有可能出现数据不一致的情况。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">假设在系统A中的更新了缓存中的一个数据项，这个时候CacheManager会在A设置的所有的缓存handle中更新改数据，这里也包括了分布式缓存上的数据。但是在系统B中的内存缓存中，还是会存在着旧的未更新的数据。当系统B从缓存中取这条记录的时候，就会出现内存缓存和分布式缓存中的数据不一致的情况。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">为了防止这一点，缓存管理器有一个功能叫做cachebackplate将尝试同步多个系统中的缓存。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">上面设置的多级缓存中，我们就将redis作为BackPlate的源. 也就是说所有的数据都需要以redis中缓存的数据为蓝本。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">在设置redis作为BackPlate之后，同样发生上面的数据不一致的情况的时候，只要redis中的数据被修改了，就会触发CacheManager更新所有系统中的内存缓存中的数据，和redis中的数据保持一致。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><strong>同步的工作是如何完成的？</strong></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">每次一条缓存记录被删除或更新的时候，Cache Manager会发送一个消息，让BackPlate存储这次的数据变化信息。所有其它的系统将异步接收这些消息，并将相应地作出更新和删除操作，保证数据的一致性。</p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">五，ExpirationMode和CacheUpdateMode</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">涉及到缓存，就必然有缓存过期的问题。CacheManager中提供了一些简单的缓存过期方式设置。</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">1&nbsp;public&nbsp;enum&nbsp;ExpirationMode2&nbsp;{3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;None&nbsp;=&nbsp;0,4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sliding&nbsp;=&nbsp;1,5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Absolute&nbsp;=&nbsp;2,6&nbsp;}</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.5;">同时CacheManager还为多级缓存之间设置不同的数据更新策略</span></p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">1&nbsp;public&nbsp;enum&nbsp;CacheUpdateMode2&nbsp;{3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;None&nbsp;=&nbsp;0,4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Full&nbsp;=&nbsp;1,5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Up&nbsp;=&nbsp;2,6&nbsp;}</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><span style="line-height: 1.5;">使用Sliding和Up, 我们我可以为多级缓存设置不同的缓存过期时间，这样使用频率高的数据就能够保存在访问速度更快的内存中，访问频率次高的放到分布式缓存中。当CacheManager在内存中找不到缓存数据的时候，就会尝试在分布式缓存中找。找到后，根据Up设置，会再将该缓存数据保存到内存缓存中。</span></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">具体的配置方式如下:</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">&nbsp;1&nbsp;var&nbsp;cache&nbsp;=&nbsp;CacheFactory.Build&lt;int&gt;(&quot;myCache&quot;,&nbsp;settings&nbsp;=&gt;&nbsp;2&nbsp;{&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings.WithUpdateMode(CacheUpdateMode.Up)&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithSystemRuntimeCacheHandle(&quot;inProcessCache&quot;)//内存缓存Handle&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithExpiration(ExpirationMode.Sliding,&nbsp;TimeSpan.FromSeconds(60)))&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.And&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisConfiguration(&quot;redis&quot;,&nbsp;config&nbsp;=&gt;//Redis缓存配置&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.WithAllowAdmin()10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithDatabase(0)11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithEndpoint(&quot;localhost&quot;,&nbsp;6379);12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithExpiration(ExpirationMode.Sliding,&nbsp;TimeSpan.&nbsp;FromHours&nbsp;&nbsp;(24)))14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithMaxRetries(1000)//尝试次数15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRetryTimeout(100)//尝试超时时间16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisBackPlate(&quot;redis&quot;)//redis使用Back&nbsp;Plate17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithRedisCacheHandle(&quot;redis&quot;,&nbsp;true);//redis缓存handle18&nbsp;19&nbsp;});</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">六，缓存使用分析</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">在缓存使用中，对于缓存hit和miss数据态比较关系，这些数据能够帮助我们分析和调整缓存的设置，帮助缓存使用地更加合理。</p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">1&nbsp;var&nbsp;cache&nbsp;=&nbsp;CacheFactory.Build(&quot;cacheName&quot;,&nbsp;settings&nbsp;=&gt;&nbsp;settings2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithSystemRuntimeCacheHandle(&quot;handleName&quot;)3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.EnableStatistics()4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.EnablePerformanceCounters());</pre><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">在配置好缓存的Statistic功能后，我们就能够跟踪到缓存的使用情况了, 下面就是分别打印各个缓存handle中的分析数据。</p><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><pre style="margin-top: 0px; margin-bottom: 0px; white-space: pre-wrap; word-wrap: break-word; max-width: 850px; font-family: &#39;Courier New&#39; !important;">&nbsp;1&nbsp;foreach&nbsp;(var&nbsp;handle&nbsp;in&nbsp;cache.CacheHandles)&nbsp;2&nbsp;{&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;stats&nbsp;=&nbsp;handle.Stats;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(string.Format(&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Items:&nbsp;{0},&nbsp;Hits:&nbsp;{1},&nbsp;Miss:&nbsp;{2},&nbsp;Remove:&nbsp;{3},&nbsp;ClearRegion:&nbsp;{4},&nbsp;Clear:&nbsp;{5},&nbsp;Adds:&nbsp;{6},&nbsp;Puts:&nbsp;{7},&nbsp;Gets:&nbsp;{8}&quot;,&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.Items),&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.Hits),&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.Misses),&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.RemoveCalls),10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.ClearRegionCalls),11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.ClearCalls),12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.AddCalls),13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.PutCalls),14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stats.GetStatistic(CacheStatsCounterType.GetCalls)15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;));16&nbsp;}</pre><p><span class="cnblogs_code_copy" style="padding-right: 5px; font-family: &#39;Courier New&#39; !important; line-height: 1.5 !important;"><a title="复制代码" style="outline: none; color: rgb(61, 129, 238); border: none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border: none rgb(221, 221, 221) !important; background-color: rgb(255, 255, 255);"/></a></span></p><h1 style="font-size: 28px; color: white; padding: 5px; border-radius: 4px; height: 38px; line-height: 38px; font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(75, 172, 198);">七，结尾</h1><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">缓存是个好东西，用好了能够极大的提高性能。缓存的使用本身是个很大的话题，这边文章只是从缓存管理这个角度介绍了CachManager的使用。</p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><strong>下面是CacheManager相关的资料和链接:</strong></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><strong>官方主页</strong></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><a href="http://cachemanager.net/" style="outline: none; text-decoration: none; color: rgb(61, 129, 238); border-bottom-width: 1px; border-bottom-style: dashed;">http://cachemanager.net/</a></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><strong>源代码</strong></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><a href="https://github.com/MichaCo/CacheManager" style="outline: none; text-decoration: none; color: rgb(61, 129, 238); border-bottom-width: 1px; border-bottom-style: dashed;">https://github.com/MichaCo/CacheManager</a></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><strong>官方MVC项目的Sample</strong></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);"><a href="https://github.com/MichaCo/CacheManager/tree/master/samples/CacheManager.Samples.Mvc" style="outline: none; text-decoration: none; color: rgb(61, 129, 238); border-bottom-width: 1px; border-bottom-style: dashed;">https://github.com/MichaCo/CacheManager/tree/master/samples/CacheManager.Samples.Mvc</a></p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">最近在思考不同情况下缓?媸褂玫那鹞侍狻６杂诨チ钅坷此担莸囊恢滦砸蟪３２惶撸捍婀芾碇校刈⒌憧赡茉诨捍娴拿新噬稀６杂谟τ孟低常梦是肭蟛淮螅嵌杂谑莸囊恢滦砸蠼细撸捍嬷械氖莞虏呗钥赡芨又匾?/p><p style="line-height: 28.8px; margin: 10px auto; padding: 0px; color: rgb(51, 51, 51); font-family: 微软雅黑, PTSans, Arial, sans-serif, 宋体; white-space: normal; background-color: rgb(255, 255, 255);">怎样才是好的适合应用系统的缓存设计呢? 如果大家有兴趣，欢迎探讨指教。</p><p><br/></p>
                        </code>
                        </pre>
                        <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
                        <!-- UY BEGIN -->
                        <div id="uyan_frame"></div>
                        <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2113268"></script>
                        <!-- UY END -->
                    </div>
                </div>
                <div id="footerInnerSeparator"></div>
            </div>
        </div>
        <div id="footerOuterSeparator"></div>
    </div>
    <br /><br /><br />
    <script src="../../js/jquery-1.9.1.js"></script>
    <script>
        window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": $("#divMain pre code").text(), "bdMini": "2", "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {}, "image": { "viewList": ["qzone", "tsina", "tqq", "renren", "weixin"], "viewText": "分享到：", "viewSize": "16" }, "selectShare": { "bdContainerClass": null, "bdSelectMiniList": ["qzone", "tsina", "tqq", "renren", "weixin"] } }; with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</body>
</html>